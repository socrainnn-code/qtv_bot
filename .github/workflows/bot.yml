name: QTV Twitter Bot

on:
  schedule:
    - cron: '*/5 * * * *'  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create Google credentials from secrets
      run: |
        # –°–æ–∑–¥–∞–µ–º credentials.json –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –≤–∞–ª–∏–¥–µ–Ω
        if [ -f "credentials.json" ]; then
          echo "‚úÖ credentials.json created successfully"
          echo "File size: $(wc -c < credentials.json) bytes"
        else
          echo "‚ùå Failed to create credentials.json"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON
        if python -c "import json; json.load(open('credentials.json'))"; then
          echo "‚úÖ credentials.json contains valid JSON"
        else
          echo "‚ùå credentials.json contains invalid JSON"
          exit 1
        fi

    - name: Run Twitter Bot
      env:
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        TARGET_TWEET_ID: ${{ secrets.TARGET_TWEET_ID }}
      run: |
        echo "üöÄ Starting QTV Bot..."
        python qtv_bot.py

    - name: Clean up credentials
      if: always()
      run: |
        # –£–¥–∞–ª—è–µ–º credentials —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        if [ -f "credentials.json" ]; then
          rm credentials.json
          echo "‚úÖ credentials.json removed"
        fi

    - name: Show completion status
      if: always()
      run: |
        echo "‚úÖ Workflow completed: ${{ job.status }}"
